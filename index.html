<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <!--  Import Halfmoon -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/halfmoon/css/halfmoon-variables.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/halfmoon/css/halfmoon.min.css"
    />
    <!-- Import font-awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <script src="https://cdn.jsdelivr.net/npm/halfmoon/js/halfmoon.min.js"></script>
    <title>ALBW Randomizer</title>
    <style>
      html,
      body {
        font-family: "Roboto", sans-serif;
        background: #333;
        color: #f5f5f5;
      }
      .content-wrapper
      {
        display: flex;
        flex-direction: row;
        align-items: stretch;
      }

      .content-wrapper > * {
        flex: 1;
      }
    </style>
    <script>
      window.onload = () => {
        if (
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
        ) {
          halfmoon.toggleDarkMode();
        }
      };
    </script>
  </head>
  <body>
    <script type="module">
      const onlyUnique = (value, index, self) => {
        return self.indexOf(value) === index;
      };

      const internalNameToDisplayName = (internalName) => {
        if (!internalName.includes("Key") && !internalName.includes("Bottle")) {
          if (internalName.includes("02")) {
            return internalName
              .replace(/([A-Z])/g, " $1")
              .replace("02", " (Upgrade)")
              .replace(/\d+/, "")
              .trim();
          }
        }

        return internalName
          .replace(/\d+/, "")
          .replace(/([A-Z])/g, " $1")
          .trim();
      };

      const displayNameToIconPath = (itemName) => {
        const progressiveItems = ["Glove", "Sword", "Bracelet", "Mail"];
        const conversion = (itemName) => {
          if (itemName.includes("Ore")) {
            return `Master Ore`;
          }
          if (itemName.includes("Compass")) {
            return `Compass`;
          }
          const progressiveItem = progressiveItems.find((pItem) =>
            itemName.includes(pItem)
          );
          if (progressiveItem) {
            return `Progressive ${progressiveItem}`;
          }
          if (
            itemName.includes("Key") &&
            (itemName.includes("Big") || itemName.includes("Sanctuary"))
          ) {
            return `Big Key`;
          }
          if (itemName.includes("Key") && itemName.includes("Small")) {
            return `Small Key`;
          }
          return itemName;
        };

        return `./items/${conversion(itemName)}.png`;
      };

      import init, { Cartridge } from "./albw_wasm.js";
      await init();

      class GameInfo {
        constructor({settings, seed, layout}) {
          this.seed = seed;
          this.settings = settings;
          this.cartridge = new Cartridge(settings, seed);
          this.generateCheckInfo(layout);
          this.loadProgress();
          document.querySelector("#seed").innerText = seed;

          Object.keys(this.subregionByCheck).forEach(checkName => {
            const checkNameToDisplayName = (name) => {
              return name.replace(/^\[.*\] /, "").trim();
            };

            this.subregionByCheck[checkName].push(checkNameToDisplayName(checkName));
          });
        }

        resetProgress() {
          if (
            !confirm("Are you sure you want to reset ALL items and checks?")
          ) {
            return;
          }
          localStorage.removeItem("collectedItemNames." + this.seed);
          localStorage.removeItem("visitedCheckNames." + this.seed);
          refreshItems();
          refreshChecks();
        }

        saveItemProgress(collectedItemNames) {
          // store collectedItemNames in localStorage
          localStorage.setItem(
            "collectedItemNames." + this.seed,
            JSON.stringify(collectedItemNames)
          );
        }

        // store visitedChecks in local storage
        saveCheckProgress(visitedCheckNames) {
          localStorage.setItem(
            "visitedCheckNames." + this.seed,
            JSON.stringify(visitedCheckNames)
          );
        }

        loadProgress() {
          return {
            collectedItemNames:
              JSON.parse(
                localStorage.getItem("collectedItemNames." + this.seed)
              ) || [],
            visitedCheckNames:
              JSON.parse(
                localStorage.getItem("visitedCheckNames." + this.seed)
              ) || [],
          };
        }

        async getListOfUsefulProgressionItems() {
          const removeRupees = (itemName) => !itemName.includes("Rupee");
          const displayNameToIconAndRequest = ([internalName, displayName]) =>
            new Promise(async (resolve, reject) => {
              const iconPath = displayNameToIconPath(
                displayName.replace(/ \(.*/, "")
              );
              let requestSuccess = false;
              try {
                const response = await fetch(iconPath);
                if (response.ok) {
                  requestSuccess = true;
                }
              } catch (e) {
                console.error(e);
              }
              resolve({ internalName, displayName, iconPath, requestSuccess });
            });

          const getUniqueWithoutNumber = (value, index, self) => {
            if (
              value.displayName.includes("Ravio") ||
              value.displayName.includes("Glove")
            ) {
              return () => true;
            }
            return onlyUnique(
              value.internalName.replace(/\d+/, ""),
              index,
              self.map((itemData) => itemData.internalName.replace(/\d+/, ""))
            );
          };

          return (
            await Promise.all(
              this.cartridge
                .get_progression_item_names()
                .filter(removeRupees)
                .map((internalName) => [
                  internalName,
                  internalNameToDisplayName(internalName),
                ])
                .map(displayNameToIconAndRequest)
            )
          ).filter(getUniqueWithoutNumber);
        }
        generateCheckInfo = (layout) => {
          let mapping = [];
          let locationMapping = [];
          const fillItemByLocation = (layout, prefix) => {
            if (typeof layout == "object") {
              Object.entries(layout).forEach((item) => {
                prefix.push(item[0]);
                fillItemByLocation(item[1], prefix);
                prefix.pop();
              });
              return;
            }
            const data = JSON.parse(JSON.stringify(layout));
            mapping[prefix.at(-1)] = data;
            const path = JSON.parse(JSON.stringify(prefix));
            path.pop();
            locationMapping[prefix.at(-1)] = path;
          };
          fillItemByLocation(layout, []);
          this.itemByCheck = mapping;
          this.subregionByCheck = locationMapping;
        };
      }

      const spoilerLog = {
        seed: 2832764187,
        settings: {
          logic: {
            mode: "Normal",
            assured_weapon: false,
            bell_in_shop: false,
            pouch_in_shop: false,
            boots_in_shop: false,
            minigames_excluded: true,
            swordless_mode: false,
            super_items: true,
            skip_trials: true,
            bow_of_light_in_castle: false,
            lampless: false,
          },
          options: {
            night_mode: false,
          },
          exclusions: {},
        },
        layout: {
          Hyrule: {
            "Kakariko Village": {
              "Bee Guy": "Red Rupee",
              "Bee Guy (Golden Bee)": "Red Rupee",
              "Cucco Ranch": "Monster Tail",
              "Fortune Teller": "Hammer",
              Jail: "Red Rupee",
              "Merchant (Left)": "Monster Tail",
              "Merchant (Right)": "Piece of Heart",
              "Milk Bar Owner": "Heart Container",
              "Shady Guy": "Stamina Scroll",
              "Stylish Woman": "Red Rupee",
              "Well (Chest)": "Piece of Heart",
              "Well (Upper)": "Red Rupee",
            },
            "Eastern Ruins": {
              "Armos Chest": "Gold Rupee",
              Cave: "Red Rupee",
              "Hookshot Chest": "Monster Tail",
              "Merge Chest": "Green Rupee",
              "Merge Treasure Dungeon": "Purple Rupee",
              "Pegs (South)": "Lamp",
            },
            "Lost Woods": {
              Alcove: "Blue Rupee",
              "Lost Woods Big Rock Chest": "Flippers",
              "Master Sword Pedestal": "Monster Guts",
            },
            "Zoras Domain": {
              "Behind Waterfall": "Red Rupee",
              "Zora Queen": "Bottle",
              "Zora's Domain Ledge Chest": "Gold Rupee",
            },
            "Death Mountain": {
              "Blocked Cave": "Silver Rupee",
              "Bouldering Guy": "Piece of Heart",
              "Death Mountain West Ledge": "Piece of Heart",
              "Fairy Cave": "Purple Rupee",
              "Fire Cave Pillar": "Silver Rupee",
              "First Cave": "Red Rupee",
              "Floating Island": "Heart Container",
              "Hookshot Treasure Dungeon": "Monster Guts",
              "Rock Cave (Pegs)": "Smooth Gem",
              "Rock Cave (Top)": "Piece of Heart",
              "Spectacle Rock": "Silver Rupee",
            },
            "Hyrule Field": {
              "Behind Blacksmith": "Silver Rupee",
              Blacksmith: "Silver Rupee",
              "Blacksmith Cave": "Piece of Heart",
              "Castle (Indoors)": "Piece of Heart",
              "Castle Balcony": "Blue Rupee",
              "Castle Rocks": "Gold Rupee",
              "Clean Rocks": "Silver Rupee",
              Dampe: "Pegasus Boots",
              "Haunted Grove Tree Stump": "Master Ore",
              "Ravio (1)": "Piece of Heart",
              "Ravio (2)": "Heart Container",
              "Ravio (3)": "Premium Milk",
              "Ravio (4)": "Purple Rupee",
              "Ravio (5)": "Piece of Heart",
              "Ravio (6)": "Green Rupee",
              "Ravio (7)": "Piece of Heart",
              "Ravio (8)": "Red Rupee",
              "Ravio (9)": "Silver Rupee",
              Rosso: "Sand Rod",
              "Rosso Cave": "Silver Rupee",
              "Rupee Rush (Hyrule)": "Red Rupee",
              "Sanctuary Cave": "Red Rupee",
              "Sanctuary Pegs": "Silver Rupee",
              "Sanctuary Treasure Dungeon": "Purple Rupee",
            },
            "Southern Ruins": {
              "Behind Pillars": "Master Ore",
              "Runaway Item Seller": "Net",
              "Southern Ruins Ledge": "Heart Container",
              "Treasure Room": "Silver Rupee",
            },
            "Hyrule Sanctuary": {
              "[HS] Entrance": "Monster Horn",
              "[HS] Ledge": "Small Key",
              "[HS] Lower Chest": "Blue Rupee",
              "[HS] Upper Chest": "Hookshot",
            },
            "Lake Hylia": {
              "Bird Lover": "Monster Guts",
              "Hyrule Hotfoot": "Monster Guts",
              "Lake Hylia Ledge Chest": "Heart Container",
              "Secret Cave": "Silver Rupee",
              Shore: "Message in a Bottle",
              "Torch Cave": "Monster Tail",
            },
          },
          Lorule: {
            "Lorule Field": {
              "Big Bomb Cave": "Monster Guts",
              "Blacksmith (Lorule)": "Blue Rupee",
              "Boots Treasure Dungeon": "Piece of Heart",
              "Great Rupee Fairy": "Progressive Mail",
              "Hookshot Ledge": "Progressive Glove",
              "Octoball Derby": "Piece of Heart",
              "Rupee Rush (Lorule)": "Heart Container",
              "Swamp Cave (Left)": "Blue Rupee",
              "Swamp Cave (Middle)": "Piece of Heart",
              "Swamp Cave (Right)": "Net",
              "Thief Girl Cave": "Heart Container",
              "Vacant House": "Red Rupee",
            },
            "Dark Ruins": {
              "Dark Maze Chest": "Progressive Sword",
              "Dark Maze Ledge": "Silver Rupee",
              "Dark Ruins Lakeview Chest": "Piece of Heart",
              "Hinox (1)": "Silver Rupee",
              "Hinox (2)": "Blue Rupee",
              "Hinox (3)": "Blue Rupee",
              "Hinox (4)": "Fire Rod",
              "Hinox (5)": "Silver Rupee",
              "Hinox (6)": "Purple Rupee",
            },
            "Skull Woods": {
              "Canyon House": "Red Rupee",
              "Cucco Shack": "Lamp",
              "Skull Woods Outdoor Chest": "Bottle",
            },
            "Death Mountain": {
              "Behind Ice Gimos (East)": "Purple Rupee",
              "Defeat Ice Gimos (West)": "Master Ore",
              "Ledge (East)": "Silver Rupee",
              "Ledge (West)": "Boomerang",
              "Treacherous Tower (Intermediate)": "Piece of Heart",
            },
            Graveyard: {
              "Peninsula Chest": "Purple Rupee",
              "Philosopher's Cave Big Chest": "Red Rupee",
            },
            "Misery Mire": {
              "Misery Mire Ledge": "Silver Rupee",
              "Sand Rod Treasure Dungeon": "Hylian Shield",
            },
            "Lorule Lake": {
              "Lorule Lake NW Chest": "Purple Rupee",
              "Turtle Rock Left Balcony": "Silver Rupee",
            },
          },
          Dungeons: {
            "Thieves Hideout": {
              Stalblind: "Purple Rupee",
              "[TH] (B1) Behind Wall": "Bottle",
              "[TH] (B1) Big Chest (Entrance)": "Big Key",
              "[TH] (B1) Grate Chest": "Compass",
              "[TH] (B1) Jail Cell": "Small Key",
              "[TH] (B2) Eyegores": "Heart Container",
              "[TH] (B2) Grate Chest (Fall)": "Silver Rupee",
              "[TH] (B2) Jail Cell": "Master Ore",
              "[TH] (B2) Switch Puzzle Room": "Silver Rupee",
              "[TH] (B3) Big Chest (Hidden)": "Piece of Heart",
              "[TH] (B3) Underwater": "Red Rupee",
            },
            "House of Gales": {
              "[HoG] (1F) Blue Bari Room": "Small Key",
              "[HoG] (1F) Blue Bari Room (Bottom Left)": "Small Key",
              "[HoG] (1F) Fire Bubbles": "Silver Rupee",
              "[HoG] (1F) Switch Room": "Small Key",
              "[HoG] (1F) Torches": "Small Key",
              "[HoG] (2F) Big Chest": "Bottle",
              "[HoG] (2F) Fire Ring": "Silver Rupee",
              "[HoG] (2F) Narrow Ledge": "Compass",
              "[HoG] (3F) Fire Bubbles": "Purple Rupee",
              "[HoG] (3F) Rat Room": "Big Key",
              "[HoG] Margomill": "Monster Guts",
            },
            "Tower of Hera": {
              "[ToH] (11F) Big Chest": "Blue Rupee",
              "[ToH] (1F) Center": "Piece of Heart",
              "[ToH] (1F) Outside": "Silver Rupee",
              "[ToH] (3F) Platform": "Small Key",
              "[ToH] (5F) Red/Blue Switches": "Gold Rupee",
              "[ToH] (6F) Left Mole": "Small Key",
              "[ToH] (6F) Right Mole": "Big Key",
              "[ToH] (7F) Outside (Ledge)": "Silver Rupee",
              "[ToH] (8F) Fairy Room": "Compass",
              "[ToH] Moldorm": "Piece of Heart",
            },
            "Dark Palace": {
              "[PoD] (1F) Fall From 2F": "Piece of Heart",
              "[PoD] (1F) Hidden Room (Lower)": "Small Key",
              "[PoD] (1F) Hidden Room (Upper)": "Silver Rupee",
              "[PoD] (1F) Narrow Ledge": "Small Key",
              "[PoD] (1F) Near Entrance": "Silver Rupee",
              "[PoD] (1F) Switch Puzzle": "Small Key",
              "[PoD] (2F) Alcove": "Monster Guts",
              "[PoD] (2F) Big Chest (Hidden)": "Silver Rupee",
              "[PoD] (B1) Big Chest (Switches)": "Compass",
              "[PoD] (B1) Fall From 1F": "Gold Rupee",
              "[PoD] (B1) Helmasaur Room": "Big Key",
              "[PoD] (B1) Helmasaur Room (Fall)": "Tornado Rod",
              "[PoD] (B1) Maze": "Small Key",
              "[PoD] Gemesaur King": "Silver Rupee",
            },
            "Lorule Castle": {
              "[LC] (1F) Center": "Small Key",
              "[LC] (1F) Ledge": "Small Key",
              "[LC] (2F) Hidden Path": "Purple Rupee",
              "[LC] (2F) Ledge": "Silver Rupee",
              "[LC] (2F) Near Torches": "Small Key",
              "[LC] (3F) Ball Trial (Chest)": "Silver Rupee",
              "[LC] (3F) Ball Trial (Puzzle)": "Small Key",
              "[LC] (3F) Bomb Trial (Behind Rock)": "Progressive Sword",
              "[LC] (3F) Bomb Trial (Chest)": "Bow",
              "[LC] (4F) Center": "Compass",
              "[LC] (4F) Hidden Path": "Small Key",
              "[LC] (4F) Hookshot Trial (Chest)": "Heart Container",
              "[LC] (4F) Hookshot Trial (Eyes)": "Silver Rupee",
              "[LC] (4F) Lamp Trial": "Progressive Sword",
              "[LC] Zelda": "Heart Container",
            },
            "Eastern Palace": {
              "[EP] (1F) Defeat Popos": "Bell",
              "[EP] (1F) Hidden Door": "Compass",
              "[EP] (1F) Near Entrance": "Small Key",
              "[EP] (1F) Outside (East)": "Big Key",
              "[EP] (1F) Outside (West)": "Silver Rupee",
              "[EP] (1F) Switch Puzzle": "Progressive Bracelet",
              "[EP] (2F) Ball Room": "Gold Rupee",
              "[EP] (2F) Big Chest": "Silver Rupee",
              "[EP] (2F) Defeat Popos": "Progressive Bracelet",
              "[EP] (2F) Switch Room": "Small Key",
              "[EP] (3F) After Cutscene": "Purple Rupee",
              "[EP] (3F) Outside (North)": "Red Rupee",
              "[EP] Yuga": "Purple Rupee",
            },
            "Skull Woods": {
              "[SW] (B1) Big Chest (Eyes)": "Compass",
              "[SW] (B1) Big Chest (Upper)": "Bow of Light",
              "[SW] (B1) Gibdo Room (Hole)": "Progressive Glove",
              "[SW] (B1) Gibdo Room (Lower)": "Small Key",
              "[SW] (B1) Grate Room": "Small Key",
              "[SW] (B1) South Chest": "Small Key",
              "[SW] (B2) Moving Platform Room": "Big Key",
              "[SW] Knucklemaster": "Bottle",
            },
            "Ice Ruins": {
              "[IR] (1F) Hidden Chest": "Compass",
              "[IR] (B1) East Chest": "Silver Rupee",
              "[IR] (B1) Narrow Ledge": "Small Key",
              "[IR] (B1) Upper Chest": "Small Key",
              "[IR] (B2) Far North": "Red Rupee",
              "[IR] (B3) Big Chest (Puzzle)": "Gold Rupee",
              "[IR] (B3) Grate Chest (Left)": "Small Key",
              "[IR] (B3) Grate Chest (Right)": "Big Key",
              "[IR] (B4) Ice Pillar": "Red Rupee",
              "[IR] (B4) Narrow Platform": "Monster Guts",
              "[IR] (B4) Southeast Chest (Fall)": "Purple Rupee",
              "[IR] (B4) Southwest Chest (Fall)": "Silver Rupee",
              "[IR] (B4) Switches": "Piece of Heart",
              "[IR] (B5) Big Chest": "Silver Rupee",
              "[IR] Dharkstare": "Monster Horn",
            },
            "Turtle Rock": {
              "[TR] (1F) Center": "Small Key",
              "[TR] (1F) Defeat Flamolas": "Gold Rupee",
              "[TR] (1F) Grate Chest": "Compass",
              "[TR] (1F) Northeast Ledge": "Piece of Heart",
              "[TR] (1F) Portal Room (Northwest)": "Small Key",
              "[TR] (1F) Southeast Chest": "Silver Rupee",
              "[TR] (B1) Big Chest (Center)": "Piece of Heart",
              "[TR] (B1) Big Chest (Top)": "Piece of Heart",
              "[TR] (B1) Grate Chest (Small)": "Small Key",
              "[TR] (B1) Northeast Room": "Big Key",
              "[TR] (B1) Platform": "Purple Rupee",
              "[TR] Grinexx": "Silver Rupee",
            },
            "Desert Palace": {
              Zaganaga: "Progressive Mail",
              "[DP] (1F) Behind Rocks": "Small Key",
              "[DP] (1F) Big Chest (Behind Wall)": "Small Key",
              "[DP] (1F) Entrance": "Hint Glasses",
              "[DP] (1F) Sand Room (North)": "Progressive Sword",
              "[DP] (1F) Sand Room (South)": "Silver Rupee",
              "[DP] (1F) Sand Switch Room": "Pouch",
              "[DP] (2F) Beamos Room": "Compass",
              "[DP] (2F) Big Chest (Puzzle)": "Big Key",
              "[DP] (2F) Leever Room": "Small Key",
              "[DP] (2F) Red/Blue Switches": "Small Key",
              "[DP] (2F) Under Rock (Ball Room)": "Monster Guts",
              "[DP] (2F) Under Rock (Left)": "Piece of Heart",
              "[DP] (2F) Under Rock (Right)": "Piece of Heart",
              "[DP] (3F) Armos Room": "Purple Rupee",
              "[DP] (3F) Behind Falling Sand": "Small Key",
            },
            "Lorule Sanctuary": {
              "[LS] Entrance Chest": "Small Key",
              "[LS] Ledge": "Red Rupee",
              "[LS] Lower Chest": "Bee Badge",
              "[LS] Upper Chest": "Purple Rupee",
            },
            "Swamp Palace": {
              "[SP] (1F) Big Chest (Fire)": "Bombs",
              "[SP] (1F) East Room": "Small Key",
              "[SP] (1F) Water Puzzle": "Big Key",
              "[SP] (1F) West Room": "Small Key",
              "[SP] (B1) Big Chest (Secret)": "Purple Rupee",
              "[SP] (B1) Center": "Monster Horn",
              "[SP] (B1) Gyorm": "Small Key",
              "[SP] (B1) Raft Room (Left)": "Piece of Heart",
              "[SP] (B1) Raft Room (Pillar)": "Ice Rod",
              "[SP] (B1) Raft Room (Right)": "Small Key",
              "[SP] (B1) Waterfall Room": "Compass",
              "[SP] Arrghus": "Piece of Heart",
            },
          },
        },
      };

      window.gameInfo = new GameInfo(spoilerLog);

      console.log(window.gameInfo.cartridge);
      console.log(window.gameInfo.cartridge.get_trash_item_names());
      console.log(window.gameInfo.cartridge.get_progression_item_names());
      console.log(window.gameInfo.cartridge.get_available_checks([]));
      console.log(window.gameInfo.cartridge.get_available_checks(["Bow01"]));
      console.log(window.gameInfo.subregionByCheck);
      console.log(window.gameInfo.itemByCheck);

      // @TODO: Explicitly add Ravios bracelet

      const getCurrentlyCollectedItemCards = () =>
        Array.from(
          document.querySelectorAll("#progressive-item-list .card")
        ).map((e) => {
          return {
            checked: e.querySelector("input").checked,
            internalName: e.dataset.internalName,
          };
        });

      const refreshItems = async () => {
        const createElement = ({ internalName, displayName, iconPath }) => {
          // create halfmoon css card with left-aligned and vertically centered image and title on same line
          const card = document.createElement("div");
          card.classList.add("card", "d-flex", "align-items-center");
          card.dataset.internalName = internalName;

          // add image to card
          const cardImage = document.createElement("img");
          cardImage.src = iconPath;
          cardImage.style.marginRight = "10px";
          card.appendChild(cardImage);
          // add text to card
          const cardText = document.createElement("p");
          cardText.classList.add("card-body");
          cardText.innerText = displayName;
          card.appendChild(cardText);

          // add hidden checkbox that gets toggled when card is clicked
          const cardCheckbox = document.createElement("input");
          cardCheckbox.type = "checkbox";
          cardCheckbox.classList.add("d-none");
          cardCheckbox.addEventListener("change", (e) => {
            if (e.target.checked) {
              card.classList.add("bg-primary");
            } else {
              card.classList.remove("bg-primary");
            }
          });
          card.appendChild(cardCheckbox);

          // add click event listener to card
          card.addEventListener("click", () => {
            // @TODO: Persist progression for current seed inside local storage
            cardCheckbox.checked = !cardCheckbox.checked;
            cardCheckbox.dispatchEvent(new Event("change"));
            const currentlyCollectedItems = getCurrentlyCollectedItemCards();
            refreshChecks(currentlyCollectedItems);
            window.gameInfo.saveItemProgress(
              currentlyCollectedItems
                .filter((a) => a.checked)
                .map((item) => item.internalName)
            );
          });

          cardCheckbox.checked = window.gameInfo
            .loadProgress()
            .collectedItemNames.includes(internalName);
          cardCheckbox.dispatchEvent(new Event("change"));
          return card;
        };

        const progressionItemData =
          await window.gameInfo.getListOfUsefulProgressionItems();
        const itemListContainer = document.querySelector(
          "#progressive-item-list"
        );
        itemListContainer.innerHTML = "";
        progressionItemData.forEach((itemData) =>
          document
            .querySelector("#progressive-item-list")
            .appendChild(createElement(itemData))
        );
      };

      const refreshChecks = () => {
        let collectedChecks = window.gameInfo.loadProgress().visitedCheckNames;
        const collectedItems = getCurrentlyCollectedItemCards();
        const collectedItemsNames = collectedItems
          .filter((item) => item.checked)
          .map((item) => item.internalName);

        const availableChecks =
          window.gameInfo.cartridge.get_available_checks(collectedItemsNames);

        const alreadyVisitedChecks =
          window.gameInfo.loadProgress().visitedCheckNames;

        const onlyChecksWithSubregion = (checkName) =>
          window.gameInfo.subregionByCheck[checkName] !== undefined;

        const alphabeticallyBySubregionAndRegion = (checkNameA, checkNameB) => {
          const subregionA = window.gameInfo.subregionByCheck[checkNameA];
          const subregionB = window.gameInfo.subregionByCheck[checkNameB];
          if (subregionA[0] === subregionB[0]) {
            if (subregionA[1] === subregionB[1]) {
              return subregionA[2] < subregionB[2] ? -1 : 1;
            }
            return subregionA[1] < subregionB[1] ? -1 : 1;
          }
          return subregionA[0] < subregionB[0] ? -1 : 1;
        };

        const calculateLongestSubregionNameForAllAvailableChecks = () => {
          let levelAndLength = {};
          availableChecks.forEach((checkName) => {
            const subregion = window.gameInfo.subregionByCheck[checkName];
            if (!subregion)
            {
              return;
            }
            for (let index = 0; index < subregion.length; index++) {
              const element = subregion[index];
              levelAndLength[index] = Math.max(
                levelAndLength[index] || 0,
                element.length
              );
            }
          });
          return levelAndLength;
        };

        const longestSubregionNameForAllAvailableChecks = calculateLongestSubregionNameForAllAvailableChecks();

        const availableCheckCards = availableChecks
          .filter(onlyChecksWithSubregion)
          .sort(alphabeticallyBySubregionAndRegion)
          .map((checkName) => {
            // create halfmoon css card with left-aligned and vertically centered image and title on same line
            const card = document.createElement("div");
            card.classList.add("card", "d-flex", "align-items-center");
            card.dataset.checkName = checkName;

            // add hidden checkbox that gets toggled when card is clicked
            const cardCheckbox = document.createElement("input");
            cardCheckbox.type = "checkbox";
            cardCheckbox.addEventListener("change", (e) => {
              if (e.target.checked) {
                card.classList.remove("bg-primary");
              } else {
                card.classList.add("bg-primary");
              }

              if (cardCheckbox.checked) {
                collectedChecks.push(checkName);
              } else {
                collectedChecks = collectedChecks.filter(
                  (check) => check !== checkName
                );
              }

              cardCheckbox.checked = !cardCheckbox.checked;
              cardCheckbox.dispatchEvent(new Event("change"));
            });
            card.appendChild(cardCheckbox);

            // create halfmoon breadcrumb element based on subregion array
            const breadcrumb = document.createElement("nav");
            breadcrumb.classList.add("breadcrumb", "text-monospace");
            breadcrumb.style.width = "50%";
            breadcrumb.style.margin = "0";
            breadcrumb.style.padding = "0";
            breadcrumb.style.marginLeft = "auto";
            breadcrumb.style.marginRight = "auto";
            breadcrumb.style.marginBottom = "10px";
            breadcrumb.style.marginTop = "10px";

            window.gameInfo.subregionByCheck[checkName].forEach((subregionName, index) => {
              const breadcrumbItem = document.createElement("p");
              breadcrumbItem.classList.add("breadcrumb-item");
              let spacesToAdd = longestSubregionNameForAllAvailableChecks[index] - subregionName.length;
              if (spacesToAdd > 0) {
                subregionName += "&nbsp;".repeat(spacesToAdd);
              }
              breadcrumbItem.innerHTML = subregionName;
              breadcrumb.appendChild(breadcrumbItem);
            });
            card.appendChild(breadcrumb);

            cardCheckbox.checked = collectedChecks.includes(checkName);
            cardCheckbox.dispatchEvent(new Event("change"));

            // add halfmoon button
            const cardEye = document.createElement("i");
            cardEye.classList.add("fas", "fa-eye-slash");

            const cardButton = document.createElement("button");
            cardButton.classList.add("btn", "btn-primary", "btn-sm");
            cardButton.addEventListener("click", () => {
              card.classList.toggle("show-spoiler");
              cardEye.classList.toggle("fa-eye");
              cardEye.classList.toggle("fa-eye-slash");
            });
            cardButton.appendChild(cardEye);
            card.appendChild(cardButton);

          

            // add item found at that check
            const breakItem = document.createElement("div");
            breakItem.classList.add("flex-break");
            card.appendChild(breakItem);

            // add item found at that check
            const cardItem = document.createElement("p");
            cardItem.classList.add("full-width", "spoiler-entry");
            cardItem.innerText = window.gameInfo.itemByCheck[checkName];
            card.appendChild(cardItem);

            // add click event listener to card
            card.addEventListener("click", () => {
              if (window.map.isInEditMode)
              {
                window.map.setCurrentCheck(checkName);
                return;
              }

              if (window.map.marker[checkName])
              {
                window.map.marker[checkName].fire("click");
                window.map.map.jumpTo({center: window.map.marker[checkName].getLngLat(), zoom: 12});
              }
              // @TODO: Persist progression for current seed inside local storage
              cardCheckbox.checked = !cardCheckbox.checked;
              cardCheckbox.dispatchEvent(new Event("change"));
              if (cardCheckbox.checked) {
                collectedChecks.push(checkName);
              } else {
                collectedChecks = collectedChecks.filter(
                  (check) => check !== checkName
                );
              }
            });

            cardCheckbox.checked = alreadyVisitedChecks.includes(checkName);
            cardCheckbox.dispatchEvent(new Event("change"));
            return card;
          }
        );
        const checkList = document.querySelector("#check-list");
        checkList.innerHTML = "";
        availableCheckCards.forEach((element) =>
          document.querySelector("#check-list").appendChild(element)
        );
      };

      await refreshItems();
      refreshChecks();
    </script>

    <div class="page-wrapper with-navbar">
      <nav class="navbar">
        <p class="navbar-text text-monospace">
          Seed:&nbsp;<span id="seed"></span>
        </p>

        <div class="custom-switch d-none d-md-flex ml-auto">
          <input type="checkbox" id="edit-mode" value="" onchange="window.map.setEditMode(this.checked)">
          <label for="edit-mode">Edit mode</label>
        </div>
        <button
          class="d-none d-md-flex ml-auto btn btn-primary"
          onclick="window.gameInfo.resetProgress()"
        >
          Reset
        </button>
      </nav>

      <!-- Content wrapper -->
      <div class="content-wrapper">
        <div class="lists">
          <div class="checklist-wrapper">
            <h2 class="page-title">Progression Items</h2>
            <div class="checklist" id="progressive-item-list"></div>
          </div>
          <div class="checklist-wrapper">
            <h2 class="page-title">Checks</h2>
            <div class="checklist" id="check-list"></div>
          </div>
          <style>
            .map {
              flex-grow: 0.4;
            }

            .card {
              user-select: none;
              cursor: pointer;
            }
  
            .lists {
              /* grid taking 50% of horizontal and 100% of all screen space and individually scrollable insides */
              display: grid;
              grid-template-columns: 50% 50%;
              height: 100%;
              overflow: hidden;
            }

            .card 
            {
              display: flex;
              flex-wrap: wrap;
              flex-direction: row;
              align-content: center;
            }

            #check-list .card
            {
              justify-content: space-between;
            }

            .card input
            {
              width: 50px;
            }
  
            .card nav
            {
              margin: 0 !important;
              text-align: left;
            }
  
            .checklist-wrapper {
              overflow-y: auto;
              height: 100%;
            }
  
            /* vertical list of items as flexbox */
            .checklist {
              display: flex;
              flex-direction: column;
              height: 100%;
            }
  
            .checklist .card {
              order: 1;
            }
  
            .checklist .card.bg-primary {
              order: 2;
            }
  
            .checklist img {
              width: 32px;
              height: 32px;
            }
  
            .checklist p {
              margin: 0;
            }
  
            .checklist .card {
              margin: 0.25em;
              padding: 0.25em;
            }

            .flex-break {
              flex-basis: 100%;
              width: 0;
            }

            .spoiler-entry {
              display: none;
              border-top: 2px solid rgba(255, 255, 255, 0.25);
              margin-top: 1em !important;
              padding-top: 0.5em;
            }

            .show-spoiler .spoiler-entry {
              display: block;
            }

            .full-width {
              width: 100%;
              text-align: center;
            }

            i {
              display: block;
              text-align: center;
            }
          </style>
        </div>
        <div class="map">
            <div id="map"></div>
            <pre id="dump"></pre>
          <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
          <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
          <style>
            .mapContainer { position: relative; margin: 0; padding: 0; background-color: black; width:100vw; height:100vh; display: block;}
            #map { position: relative; top: 0; height: 50%; }
            #dump { position: relative; top: 0; left: 0; height: 50%; color: white; }
          </style>
          <script>
              class InteractiveMap {
                  constructor()
                  {
                      this.marker = {};
                      this.markerData = {};
                      this.isInEditMode = false;
          
                      this.map = new maplibregl.Map({
                          container: 'map', // container id
                          style: {
                              'version': 8,
                              'sources': {
                                  "image": {
                                      "type": "image",
                                      "url": "map/map.png",
                                      "coordinates": [
                                          [0, 1],
                                          [1, 1],
                                          [1, 0],
                                          [0, 0]
                                      ]
                                  }
                              },
                              'layers': [
                                  {
                                      'id': 'simple-tiles',
                                      'type': 'raster',
                                      'source': 'image',
                                      'minzoom': 0,
                                      'maxzoom': 0,
                                  }
                              ]
                          },
                          center: [0.25, 0.5], // starting position
                          zoom: 10 // starting zoom
                      });
                      this.map.setRenderWorldCopies(false);
                      
                      this.map.on('click', this.setPosition.bind(this));
                      this.fetchDataFromLocalStorage();
                      this.updatePins();
                  }
          
                  setCurrentCheck(checkName)
                  {
                      this.currentCheckName = checkName;
                  }
          
                  setPosition(e, key)
                  {
                      let lngLat = undefined;
                      if (e.type == 'click')
                      {
                          lngLat = e.lngLat;
                      }
                      if (e.type == 'dragend')
                      {
                          lngLat = e.target.getLngLat();
                          this.currentCheckName = key;
                      }
          
                      if (!lngLat)
                      {
                          throw new Error(`Couldn't determine lngLat for event of type '${e.type}'`);
                      }
          
                      if (!this.currentCheckName)
                      {
                          console.warn("No check name set");
                          return;
                      }
                      this.markerData[this.currentCheckName] = lngLat;
                      console.log(`Set ${this.currentCheckName} to ${lngLat}`);
                      
                      this.updatePins();
                  }
          
                  getRawData() {
                      // pretty print
                      return Object.fromEntries(
                        Object.entries(this.markerData)
                            .map(([key, value]) => [key, [value.lng, value.lat]])
                      );
                  }

                  fetchDataFromLocalStorage()
                  {
                      const rawData = localStorage.getItem("mapData");
                      if (rawData)
                      {
                          this.markerData = Object.fromEntries(
                              Object.entries(JSON.parse(rawData))
                                  .map(([key, value]) => [key, new maplibregl.LngLat(value[0], value[1])])
                          );
                      }
                      this.updatePins();
                  }

                  setEditMode(active)
                  {
                      this.isInEditMode = active;
                      Object.values(this.marker).forEach(marker => marker.setDraggable(active))
                  }
          
                  updatePins()
                  {
                      // clear this.marker
                      Object.values(this.marker).forEach(marker => marker.remove());
                      this.marker = Object.fromEntries(Object.entries(this.markerData).map(([key, value]) =>
                          [key, new maplibregl.Marker()
                              .setLngLat(value)
                              .setPopup(new maplibregl.Popup({ offset: 25 })
                                  .setHTML('<h3>' + key + '</h3>')
                              )
                              .setDraggable(this.isInEditMode)
                              .on('dragend', ((e) => this.setPosition(e, key)).bind(this))
                              .addTo(this.map)])
                      );
                      const rawData = this.getRawData();
                      document.querySelector("pre").innerText = JSON.stringify(rawData, null, 4);
                      localStorage.setItem("mapData", JSON.stringify(rawData));
                  }
              }
          
              window.map = new InteractiveMap();
          </script>
        </div>
      </div>
    </div>
  </body>
</html>
